# Pelago Payment for WooCommerce 使用ガイド

## プラグイン概要

Pelago Payment for WooCommerceは、WordPress WooCommerceストア専用に設計されたデジタル決済プラグインで、PelagoのデジタルQRコード決済方式によるオンライン決済をサポートします。

## システム要件

- WordPress 5.0以上
- WooCommerce 3.0以上
- PHP 7.4以上
- SSL証明書（本番環境での使用を推奨）

## インストール手順

### 方法1：手動フォルダアップロード

`pelagopay-gateway`フォルダ全体をWordPressウェブサイトの`/wp-content/plugins/`ディレクトリにアップロードします。

### 方法2：WordPress管理画面でZIPファイルをアップロード

1. GitHub Releaseから最新版の`pelagopay-gateway.zip`ファイルをダウンロード：
   - プラグインのGitHubリポジトリにアクセス
   - **Releases**タブをクリック
   - 最新のtagバージョンを選択
   - `pelagopay-gateway.zip`ファイルをダウンロード
2. WordPress管理画面にログイン
3. **プラグイン** > **新規追加**に移動
4. **プラグインのアップロード**ボタンをクリック
5. ダウンロードした`pelagopay-gateway.zip`ファイルを選択し**今すぐインストール**をクリック
6. インストール完了後、**プラグインを有効化**をクリック

### プラグインの有効化（方法1使用時）

1. WordPress管理画面にログイン
2. **プラグイン** > **インストール済みプラグイン**に移動
3. "Pelago Payment for WooCommerce"プラグインを見つける
4. **有効化**ボタンをクリック

### 3. 依存関係の確認

プラグインは自動的にWooCommerceがインストールされ有効化されているかチェックします。WooCommerceがインストールされていないか有効化されていない場合、対応する通知メッセージが表示されます。

## 設定構成

### 1. 決済設定へのアクセス

1. WordPress管理画面で**WooCommerce** > **設定**に移動
2. **決済**タブをクリック
3. **Pelago Payment**オプションを見つける

### 2. 基本設定

#### 有効/無効
- **Pelago Paymentを有効にする**：Pelago決済方式を有効にするにはこのオプションをチェック

#### 表示設定
- **タイトル**：顧客がチェックアウトページで見る決済方式名
  - デフォルト値：`Pelago Payment`
- **説明**：顧客がチェックアウトページで見る決済方式の説明
  - デフォルト値：`Pay with Pelago's digital QR Code payment method.`
- **指示**：サンキューページと注文メールに追加される指示文

### 3. API設定（重要）

以下の設定項目は、プラグインが正常に動作するために必要なパラメータです。Pelagoに連絡して取得してください：

#### merchantId
- **説明**：あなたのPelagoPay商店ID
- **取得方法**：Pelago商店ダッシュボードから取得

#### appKey  
- **説明**：あなたのPelagoPayアプリケーションキー
- **取得方法**：Pelago商店ダッシュボードから取得

#### merchantPrikey
- **説明**：商店秘密鍵、署名検証に使用
- **セキュリティ注意**：安全に保管し、他人に漏らさないでください

#### platformPublicKey
- **説明**：プラットフォーム公開鍵、コールバック署名の検証に使用
- **取得方法**：Pelagoの技術文書から取得

### 4. テストモード

- **テストモードを有効にする**：テスト環境を使用するにはこのオプションをチェック
  - テスト環境API：`https://pgpay-stage.weroam.xyz`および`https://stage-api.pelagotech.com`
  - 本番環境API：`https://pgpay.weroam.xyz`および`https://api.pelagotech.com`

## 使用フロー

### 1. 顧客決済フロー

1. 顧客があなたのストアで商品を選択し、カートに追加
2. チェックアウトページで決済方式として「Pelago Payment」を選択
3. 「注文する」ボタンをクリック
4. システムが自動的に通貨変換を実行（USDに変換）
5. 顧客がPelago決済ページにリダイレクト
6. 顧客がQRコードを使用して決済を完了
7. 決済完了後、自動的に注文確認ページに戻る

### 2. 注文ステータス管理

プラグインはPelagoのコールバックに基づいて自動的に注文ステータスを更新します：

- **決済成功**：注文ステータスが「処理中」に更新
- **決済タイムアウト**：注文ステータスが「失敗」に更新
- **決済キャンセル**：注文ステータスが「キャンセル済み」に更新
- **部分決済**：注文ステータスが「失敗」に更新
- **過払い**：注文ステータスが「処理中」に更新

## コールバックURL設定（オプション）

プラグインは自動的に以下の形式でコールバックURLを生成します：
```
https://yourdomain.com/?wc-api=wc_pelagopay_gateway
```

このURLをPelago技術サポートチームに提供して設定してもらってください。
注文時にコールバックリンクが注文と一緒に送信され、Pelagoは決済成功後にこのリンクを呼び出します。

## 通貨サポート

- プラグインは複数の通貨をサポートし、注文金額を自動的にUSDに変換して決済を行います
- サポートされる通貨は、あなたのWooCommerce設定とPelagoの為替レートサービスによって決まります

## ログ記録

プラグインには詳細なログ記録機能が含まれています：
- テストモードでは詳細なデバッグ情報を記録
- 本番モードでは主要な操作とエラー情報を記録
- ログは決済問題のトラブルシューティングに役立ちます

## セキュリティ機能

- **署名検証**：すべてのAPIリクエストとコールバックでRSA署名検証を使用
- **データ暗号化**：機密データ送信にHTTPS暗号化を使用
- **リプレイ攻撃防止**：タイムスタンプと乱数を使用してリプレイ攻撃を防止

## トラブルシューティング

### よくある問題

1. **決済ページにアクセスできない**
   - API設定が正しいかチェック
   - ネットワーク接続が正常か確認
   - SSL証明書が有効か検証

2. **コールバック失敗**
   - コールバックURLが正しく設定されているかチェック
   - サーバーが外部リクエストを受信できるか確認
   - 署名設定が正しいか検証

3. **通貨変換失敗**
   - ネットワーク接続をチェック
   - 通貨コード形式が正しいか確認
   - 技術サポートに連絡して為替レートサービスをチェック

### デバッグ手順

1. デバッグのためにテストモードを有効にする
2. WordPressエラーログをチェック
3. Pelago技術サポートに連絡してサポートを受ける

## 技術サポート

技術サポートが必要な場合は、以下にお問い合わせください：
- **Pelagoウェブサイト**：https://pelagotech.com
- **技術サポート**：公式チャンネルを通じてお問い合わせください

## バージョン情報

- **現在のバージョン**：2.0.0
- **互換性**：WooCommerce 3.0+
- **更新日**：最新情報についてはプラグインファイルをご確認ください

## 重要な注意事項

1. 本番環境で使用する前に、すべての機能を十分にテストしてください
2. ウェブサイトデータを定期的にバックアップしてください
3. プラグインとWordPressシステムを最新バージョンに保ってください
4. APIキーと秘密鍵情報を適切に保護してください
5. SSL環境でこのプラグインを使用することをお勧めします
